<!DOCTYPE html>
<html>
    <head>
        <title>Pixel Art</title>
        <style>
            body {
                background-color: white;
            }

            #canvas {
                border: 1px solid #000000;
                background-color: #000000;
            }

            #controls {
                background-color: white;
            }

        </style>
    </head>
    <body>
        <div id = "menu">
            <label for="height">Height (between 1 and 250):</label>
            <input type="number" id="height" name="height" min="1" max="250" step = "1">
            <br>

            <label for="height">Width (between 1 and 250):</label>
            <input type="number" id="width" name="width" min="1" max="250" step = "1">
            <br>
            
            <button onclick="go()">Go!</button>
        </div>
        <div id = "main" style = "display: none;">
            <div id = "controls">
                <label for = "pencilColor">Pencil Color</label>
                <input type="color" id="pencilColor" name="pencilColor" value="#FF00FF">
                <br>

                <label for = "backgroundColor">Background Color</label>
                <input type="color" id="backgroundColor" name="backgroundColor" value="#A3A3A3">
                <br>
                <button onclick="fitToBox()">Fit</button>
                <button onclick="clearCanvas()">Clear</button>
                <button onclick="reset()">Reset</button>
                
                <br>
                <input type="radio" id="Pencil" name="tool" value="Pencil" onclick="selectTool(0)">
                <label for="Pencil">Pencil</label>
                <br>
                <input type="radio" id="Eraser" name="tool" value="Eraser" onclick="selectTool(1)">
                <label for="Eraser">Eraser</label>
                <br>
                <input type="radio" id="Pan" name="tool" value="Pan" onclick="selectTool(2)">
                <label for="Pan">Pan</label>
                <br>
                <input type="radio" id="Zoom" name="tool" value="Zoom" onclick="selectTool(3)">
                <label for="Zoom">Zoom</label>
                <br>
                
                
            </div>
            <br>
            <canvas id = "canvas" width="750" height="750"></canvas>
        </div>
       

        <script>
            var heightNum = document.getElementById("height").value = 50;
            var widthNum = document.getElementById("width").value = 50;
            var pixelSize = 750/Math.max(heightNum, widthNum);
            var pixels = []

            var tools = [false, false, false, false]
            var pencil = 0;
            var eraser = 1;
            var pan = 2;
            var zoom = 3;

            var backgroundColor = document.getElementById("backgroundColor").value;
            var pencilColor = document.getElementById("pencilColor").value;

            //NOT WORKING
            document.getElementById("backgroundColor").addEventListener("input", function(e){
                backgroundColor = this.value;
                render();
            });
            document.getElementById("pencilColor").addEventListener("input", function(e){
                pencilColor = this.value;
            });

            //TODO: chnage this to swap out event listeners 
            //allow zoom all the time
            //give pan space bar shortcut
            //implement fill tool
            //implement save
            //implement warning message for reset and clear
            function selectTool(tool){
                for(var i = 0; i < tools.length; i++){
                    if(i == tool){
                        tools[i] = true;
                        console.log(tool)
                    } else {
                        tools[i] = false;
                    }
                }
            }
            
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext('2d');
            
            //event listeners for drawing
            canvas.addEventListener("mousedown", (e) => {
                draw(e);
                canvas.addEventListener("mousemove", draw);
            });

            canvas.addEventListener("mouseup", (e) => {
                canvas.removeEventListener("mousemove", draw);
            })
                //touch doesn't no fully work
            canvas.addEventListener("touchstart", (e) => {
                pencil(e);
                canvas.addEventListener("touchmove", pencil);
            });

            canvas.addEventListener("touchend", (e) => {
                canvas.removeEventListener("touchmove", pencil);
            })
        
            function Pixel(x, y, color){
                this.x = x;
                this.y = y;
                this.color = color;
            }

            const viewportTransform = {
                x: 0,
                y: 0,
                scale: 1
            }

            const drawPixel = (pixel) => {
                ctx.fillStyle = pixel.color
                ctx.clearRect(pixel.x, pixel.y, pixelSize*0.95, pixelSize*0.95)
                ctx.fillRect(pixel.x, pixel.y, pixelSize*0.95, pixelSize*0.95)
            }

            let previousX = 0;
            let previousY = 0;
            const updatePanning = (e) => {
                const localX = e.clientX;
                const localY = e.clientY;

                viewportTransform.x += localX - previousX;
                viewportTransform.y += localY - previousY;

                previousX = localX;
                previousY = localY;
            }

            const updateZooming = (e) => {
                const oldScale = viewportTransform.scale;
                const oldX = viewportTransform.x;
                const oldY = viewportTransform.y;

                const localX = e.clientX;
                const localY = e.clientY;

                const previousScale = viewportTransform.scale;

                const newScale = viewportTransform.scale += e.deltaY * -0.01;

                const newX = localX - (localX - oldX) * (newScale/previousScale);
                const newY = localY - (localY - oldY) * (newScale/previousScale);

                viewportTransform.x = newX;
                viewportTransform.y = newY;
                viewportTransform.scale = newScale;
            }

            const onMouseMove = (e) => {
                if(tools[pan]){
                    updatePanning(e);
                    render();
                    console.log(e);
                }
            }

            const onMouseWheel = (e) => {
                if(tools[zoom]){
                    e.preventDefault()
                    updateZooming(e)
                    render()
                    console.log(e)
                }
            }

            function draw(e) {
                console.log(viewportTransform.x, viewportTransform.y, viewportTransform.scale)
                var tempColor = pencilColor;
                if(tools[pencil] || tools[eraser]){

                    if(tools[eraser]){
                        pencilColor = backgroundColor;
                    }
                    for(var i = 0; i < widthNum; i++){
                        if(e.offsetX >= (pixels[i][0].x)*viewportTransform.scale + viewportTransform.x && 
                        e.offsetX <= (pixels[i][0].x)*viewportTransform.scale + viewportTransform.x + 
                        pixelSize*0.95*viewportTransform.scale){
                            break;
                        }
                    }
                    for(var j = 0; j < heightNum; j++){
                        if(e.offsetY >= (pixels[i][j].y)*viewportTransform.scale + viewportTransform.y && 
                        e.offsetY <= (pixels[i][j].y)*viewportTransform.scale + viewportTransform.y + 
                        pixelSize*0.95*viewportTransform.scale){
                            pixels[i][j].color = pencilColor;
                            drawPixel(pixels[i][j]);
                            console.log(pixels[i][j]);
                        }
                    }
                    pencilColor = tempColor;
                }
                
            }

            //event listeners for pan and zoom
            canvas.addEventListener("mousedown", (e) => {
                previousX = e.clientX;
                previousY = e.clientY;

                canvas.addEventListener("mousemove", onMouseMove);
            })

            canvas.addEventListener("mouseup", (e) => {
                canvas.removeEventListener("mousemove", onMouseMove);
            })

            canvas.addEventListener("wheel", onMouseWheel, {passive: false});

            function fitToBox(){
                viewportTransform.x = 0;
                viewportTransform.y = 0;
                viewportTransform.scale = 1;
                render();
            }

            function clearCanvas(){
                for(let i = 0; i < widthNum; i++){
                    for(let j = 0; j < heightNum; j++){
                        pixels[i][j].color = backgroundColor;
                    }
                }
                render();
            }

            function render(){
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.setTransform(viewportTransform.scale, 0, 0, viewportTransform.scale, viewportTransform.x, viewportTransform.y);

                //background
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, 750, 750, "black");
                
                //render grid
                for(var i = 0; i < widthNum; i++){
                    for(var j = 0; j < heightNum; j++){
                        drawPixel(pixels[i][j]);
                    }
                }
            }

            function go(){
                heightNum = document.getElementById("height").value;
                widthNum = document.getElementById("width").value;
                pixelSize = 750/Math.max(heightNum, widthNum);

                document.getElementById("menu").style.display = "none";
                document.getElementById("main").style.display = "block";

                for(let i = 0; i < widthNum; i++){
                    var row = []
                    for(let j = 0; j < heightNum; j++){
                        row.push(new Pixel(i*pixelSize, j*pixelSize, backgroundColor));
                    }
                    pixels.push(row);
                }

                render();
            }
            
            function reset(){
                document.getElementById("menu").style.display = "block";
                document.getElementById("main").style.display = "none";
                pixels = []
            }
        </script>

    </body>
</html>